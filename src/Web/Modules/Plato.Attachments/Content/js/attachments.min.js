if(typeof $().modal=="undefined")throw new Error("BootStrap 4.1.1 or above Required");if(typeof window.$.Plato=="undefined")throw new Error("$.Plato Required");$(function(n,t,i){"use strict";n.$.Plato.attachments={allowedExtensions:["txt","html","zip","png","gif","bmp","jpg","jpeg"],maxFileSize:0};var r=n.$.Plato,u=function(){var n="attachments",t=n+"Id",u={},f={init:function(n,t,i){if(i)return i(this);if(t)return this[t]!==null&&typeof this[t]!="undefined"?this[t].apply(this,[n]):alert(t+" is not a valid method!"),null;this.bind(n)},bind:function(n){n.find('[data-provide="http-content"]').httpContent({onLoad:function(t){var u=t.find('[data-provide="delete-attachment"]');u.length>0&&u.click(function(t){var u,f,e;if(t.preventDefault(),t.stopPropagation(),u=i(this).find("i"),u.length>0&&u.removeClass("fa-times").addClass("fa-spinner").addClass("fa-spin"),f=i(this).attr("href"),f==="")throw new Error("A delete url is required!");if(e=parseInt(i(this).data("attachmentId")),isNaN(e))throw new Error("An attachment id to delete is required!");r.http({method:"POST",url:f,data:JSON.stringify(e)}).done(function(){n.find('[data-provide="http-content"]').httpContent("reload")})})}});n.find('[data-provide="attachment-dropzone"]').attachmentDropzone({allowedExtensions:r.attachments.allowedExtensions,maxFileSize:r.attachments.maxFileSize,onDrop:function(){n.find(".dropdown").each(function(){i(this).find(".dropdown-menu").removeClass("show")})},onAddedFile:function(){},onComplete:function(){n.find('[data-provide="http-content"]').httpContent("reload")},onSuccess:function(){},onError:function(){}})}};return{init:function(){for(var o,r,l,e={},s=null,c=null,h=0;h<arguments.length;++h){o=arguments[h];switch(o.constructor){case Object:i.extend(e,o);break;case String:s=o;break;case Function:c=o}}return this.length>0?this.each(function(){if(i(this).data(t))i(this).data(n,i.extend({},i(this).data(n),e));else{var r=n+parseInt(Math.random()*100)+(new Date).getTime();i(this).data(t,r);i(this).data(n,i.extend({},u,e))}f.init(i(this),s)}):(r=i('[data-provide="http-content"]'),r.length>0)?(r.data(t)?r.data(n,i.extend({},r.data(n),e)):(l=n+parseInt(Math.random()*100)+(new Date).getTime(),r.data(t,l),r.data(n,i.extend({},u,e))),f.init(r,s,c)):void 0}}}(),f=function(){var t="attachmentDropzone",u=t+"Id",e={progressPreview:"#progress",allowedExtensions:["txt","html","zip","png","gif","bmp","jpg","jpeg","pdf"],maxFileSize:2097152,dropZoneOptions:{url:"/api/attachments/streaming/upload",fallbackClick:!1,autoProcessQueue:!0,autoDiscover:!1,disablePreview:!0,uploadMultiple:!1,maxFilesize:256,dictDefaultMessage:'<p class="text-center"><i class="fal fa-arrow-from-top fa-flip-vertical fa-2x d-block text-muted mb-2"><\/i>Drag & drop files here or <a id="#dzUpload" class="dz-clickable" href="#">click to browse<\/a><\/p>'},onAddedFile:function(){},onDrop:function(){},onSuccess:function(){},onError:function(){},onComplete:function(){}},f={init:function(n,t){if(t){this[t]?this[t].apply(this,[n]):alert(t+" is not a valid method!");return}this.bind(n)},bind:function(u){var e=u.data(t).dropZoneOptions,s=this._getUrl(u),o,h;if(s===null)throw new Error("An upload url is required for the dropzone!");e.init||(e.maxFilesize=Math.ceil(u.data(t).maxFileSize/1048576),r.defaults&&(o=r.defaults.getCsrfCookieToken(),o===""&&alert("An error occurred. No valid CSRF token could be obtained for the request."),e.url=r.defaults.url+s,e.headers={Authorization:"Basic "+r.defaults.apiKey,"X-Csrf-Token":o}),e.init=function(){function s(n){return"progress-"+n.upload.uuid}function c(n){var t=i("<div>",{id:s(n),"class":"progress-row m-3"}),u=i("<div>",{"class":"progress-info text-center mb-2"}),r=i("<div>",{"class":"progress"});return r.append(i("<div>",{"class":"progress-bar",role:"progressbar",style:"width: 0;"})),t.append(u),t.append(r),t}function l(n){for(var f,e,t=!0,u=0;u<n.length;u++)h(n[u])||(t=!1);return t===!1&&(f=r.T("Some files won't be attached"),e=r.T("One or more file types you attached are not allowed. File types that are allowed will still be uploaded. Allowed types are...")+"\n\n"+o.join(", "),i().dialog({title:f,body:{url:null,html:e.replace(/\n/g,"<br/>")},buttons:[{id:"ok",text:"OK",css:"btn btn-primary",click:function(){return i().dialog("hide"),!1}}]},"show")),t}function h(n){var t;if(o===null||o.length===0)return!1;var u=n.upload.filename,i=u.split("."),f=i[i.length-1],r=null;for(t=0;t<o.length;t++)if(r=o[t],f.toLowerCase()===r.toLowerCase())return!0;return!1}var n=f._getProgressPreview(u),a=u.data(t).maxFileSize,o=u.data(t).allowedExtensions,e=[];this.on("addedfiles",function(n){return e=[],l(n)});this.on("addedfile",function(i){if(!h(i))return this.removeFile(i),!1;if(n&&n.append(c(i)),u.data(t).onAddedFile)u.data(t).onAddedFile(i);return!0});this.on("drop",function(n){if(u.data(t).onDrop)u.data(t).onDrop(n)});this.on("uploadprogress",function(t,i,r){if(n){i=Math.floor(r/t.size*100);var f="#"+s(t),u=n.find(f);u.find(".progress-info").text(i+"%");u.find(".progress-bar").width(i+"%")}});this.on("success",function(i,r){var f,o,c,h;if(r.statusCode===200&&r&&r.result)for(f=0;f<r.result.length;f++)o=r.result[f],o.error&&o.error!==""&&e.push(o.error);if(n&&(c="#"+s(i),h=n.find(c),h.length>0&&h.remove()),u.data(t).onSuccess)u.data(t).onSuccess(r)});this.on("complete",function(n){var o,f;if(e.length>0){for(o="",f=0;f<e.length;f++)o+=e[f],f<e.length-1&&(o+="\n\n");i().dialog({title:r.T("Some problems occurred"),body:{url:null,html:o.replace(/\n/g,"<br/>")},css:{body:"modal-body max-h-200 overflow-auto"},buttons:[{id:"ok",text:"OK",css:"btn btn-primary",click:function(){return i().dialog("hide"),!1}}]},"show")}if(u.data(t).onComplete)u.data(t).onComplete(n)});this.on("error",function(i,f,e){var h="<h6>"+r.T("A problem occurred!")+"<\/h6>",c,o;if(h+='<textarea class="form-control">'+f+"<\/textarea>",r.ui.notify({message:h},{mouse_over:"pause",type:"danger",allow_dismiss:!0}),n&&(c="#"+s(i),o=n.find(c),o.length>0&&o.remove()),u.data(t).onError)u.data(t).onError(i,f,e)})});n.Dropzone?(h=new n.Dropzone(u[0],e),u.data("dropzone",h)):console.log("Dropzone was configured but Dropzone was not detected. Ensure the Plato.Dropzone feature is enabled.")},_getProgressPreview:function(n){var u=n.data("progressPreview")||n.data(t).progressPreview,r;return u&&(r=i(u),r.length>0)?r:null},_getUrl:function(n){return n.data("dropzoneUrl")||n.data(t).dropZoneOptions.url}};return{init:function(){for(var o,n,l,r={},s=null,c=null,h=0;h<arguments.length;++h){o=arguments[h];switch(o.constructor){case Object:i.extend(r,o);break;case String:s=o;break;case Function:c=o}}return this.length>0?this.each(function(){if(i(this).data(u))i(this).data(t,i.extend({},i(this).data(t),r));else{var n=t+parseInt(Math.random()*100)+(new Date).getTime();i(this).data(u,n);i(this).data(t,i.extend({},e,r))}f.init(i(this),s)}):(n=i('[data-provide="attachment-dropzone"]'),n.length>0)?(n.data(u)?n.data(t,i.extend({},n.data(t),r)):(l=t+parseInt(Math.random()*100)+(new Date).getTime(),n.data(u,l),n.data(t,i.extend({},e,r))),f.init(n,s,c)):void 0}}}();i.fn.extend({attachments:u.init,attachmentDropzone:f.init});r.ready(function(){i('[data-provide="attachments"]').attachments()});i().infiniteScroll(function(){},"ready")}(window,document,jQuery));